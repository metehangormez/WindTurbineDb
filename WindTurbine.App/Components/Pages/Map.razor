@page "/map"
@using MudBlazor
@using WindTurbine.App.Services
@using WindTurbine.DTOs.Turbines
@inject IApiService ApiService
@inject IJSRuntime JS

<PageTitle>Saha Haritası</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-0" Style="height: 85vh; width: 100%; position: relative;">

    <div style="position: absolute; top: 20px; right: 20px; z-index: 1000; width: 300px;">
        <MudPaper Class="pa-4" Elevation="4">
            <MudText Typo="Typo.h6" Color="Color.Primary"><b>Canlı Saha İzleme</b></MudText>
            <MudText Typo="Typo.body2" Class="mb-2">Manisa Rüzgar Enerji Santrali</MudText>
            <MudDivider Class="mb-2" />

            <div class="d-flex align-center mb-1">
                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Success" Size="Size.Small" Class="mr-2" />
                <MudText Typo="Typo.body2">
                    Aktif:
                    <b>@turbines.Count(t =>
                                  t.LastStatus == "Aktif" ||
                                  t.LastStatus == "1" ||
                                  t.LastStatus == "0")</b>
                </MudText>
            </div>

            <div class="d-flex align-center mb-1">
                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Error" Size="Size.Small" Class="mr-2" />
                <MudText Typo="Typo.body2">
                    Arızalı:
                    <b>@turbines.Count(t =>
                                  t.LastStatus == "Arızalı" ||
                                  t.LastStatus == "5")</b>
                </MudText>
            </div>

            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Warning" Size="Size.Small" Class="mr-2" />
                <MudText Typo="Typo.body2">
                    Bakımda:
                    <b>@turbines.Count(t =>
                                  t.LastStatus == "Bakımda" ||
                                  t.LastStatus == "4")</b>
                </MudText>
            </div>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Class="mt-4"
                       OnClick="HaritayiYenile">
                Yenile
            </MudButton>
        </MudPaper>
    </div>

    <div id="map" style="width: 100%; height: 100%; min-height: 500px; z-index: 0;"></div>

</MudContainer>

@code {
    private List<TurbineDto> turbines = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
          
            await Task.Delay(500);
            await HaritayiYenile();
        }
    }

    private async Task HaritayiYenile()
    {
        try
        {
            var data = await ApiService.GetTurbinesAsync();

            if (data is not null)
            {
                turbines = data;

              
                await JS.InvokeVoidAsync("initMap", turbines);

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Harita hatası: " + ex.Message);
        }
    }
}

@page "/stats-overview"
@using WindTurbine.App.Services
@using WindTurbine.DTOs.Dashboard
@using WindTurbine.DTOs.Alerts
@using WindTurbine.DTOs.Weather
@using WindTurbine.DTOs.Turbines
@using WindTurbine.DTOs.Reports
@using MudBlazor

@inject IApiService ApiService
@inject NavigationManager NavManager

<PageTitle>İstatistik Özeti</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pt-6 pb-8">

    <div class="d-flex align-center gap-3 mb-8">
        <div class="pa-3 rounded-circle" style="background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color:white; box-shadow: 0 4px 10px rgba(13, 71, 161, 0.3);">
            <MudIcon Icon="@Icons.Material.Filled.DashboardCustomize" Size="Size.Large" />
        </div>
        <div>
            <MudText Typo="Typo.h4" Style="font-weight:800; color:#1a237e; letter-spacing:-0.5px;">Genel Bakış</MudText>
            <MudText Typo="Typo.body1" Class="mud-text-secondary">Saha performans metrikleri ve operasyonel özet.</MudText>
        </div>
    </div>

    @if (_loading)
    {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4 rounded" Style="height:6px;" />
            <MudText Align="Align.Center" Class="mud-text-secondary mt-2">Veriler hesaplanıyor...</MudText>
    }
    else
    {
            <MudGrid Class="mb-4">

                <MudItem xs="12" md="3">
                    <MudCard Elevation="4" Class="rounded-xl hover-effect h-100 position-relative overflow-hidden cursor-pointer" @onclick="@(() => NavManager.NavigateTo("/alerts"))">
                        <div class="stats-card-bg red-bg"></div>
                        <MudCardContent Class="d-flex flex-column justify-space-between h-100 pt-5 pb-3 px-5">
                            <div class="d-flex justify-space-between align-start mb-2">
                                <MudText Typo="Typo.subtitle1" Style="font-weight:600; color:#546e7a; z-index:1;">Riskli Uyarılar</MudText>
                                <div class="pa-2 rounded-lg icon-box red-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.ReportGmailerrorred" Size="Size.Medium" />
                                </div>
                            </div>
                            <div class="mt-4" style="z-index:1;">
                                <div class="d-flex align-baseline">
                                    <MudText Typo="Typo.h4" Style="font-weight:800; letter-spacing:-0.5px;">@_riskliUyariSayisi</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color:#c62828; font-weight:600;">Acil Müdahale</MudText>
                            </div>
                            <div class="d-flex justify-end mt-2"><MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Color="Color.Default" Style="opacity:0.4;" /></div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard Elevation="4" Class="rounded-xl hover-effect h-100 position-relative overflow-hidden cursor-pointer" @onclick="@(() => NavManager.NavigateTo("/analytics"))">
                        <div class="stats-card-bg green-bg"></div>
                        <MudCardContent Class="d-flex flex-column justify-space-between h-100 pt-5 pb-3 px-5">
                            <div class="d-flex justify-space-between align-start mb-2">
                                <MudText Typo="Typo.subtitle1" Style="font-weight:600; color:#546e7a; z-index:1;">AI Önerileri</MudText>
                                <div class="pa-2 rounded-lg icon-box green-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Size="Size.Medium" />
                                </div>
                            </div>
                            <div class="mt-4" style="z-index:1;">
                                <div class="d-flex align-baseline">
                                    <MudText Typo="Typo.h4" Style="font-weight:800; letter-spacing:-0.5px;">@_oneriSayisi</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color:#2e7d32; font-weight:600;">Operasyonel Fırsat</MudText>
                            </div>
                            <div class="d-flex justify-end mt-2"><MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Color="Color.Default" Style="opacity:0.4;" /></div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard Elevation="4" Class="rounded-xl hover-effect h-100 position-relative overflow-hidden cursor-pointer" @onclick="@(() => NavManager.NavigateTo("/statistics"))">
                        <div class="stats-card-bg blue-bg"></div>
                        <MudCardContent Class="d-flex flex-column justify-space-between h-100 pt-5 pb-3 px-5">
                            <div class="d-flex justify-space-between align-start mb-2">
                                <MudText Typo="Typo.subtitle1" Style="font-weight:600; color:#546e7a; z-index:1;">Emreamadelik</MudText>
                                <div class="pa-2 rounded-lg icon-box blue-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.OfflineBolt" Size="Size.Medium" />
                                </div>
                            </div>
                            <div class="mt-4" style="z-index:1;">
                                <div class="d-flex align-baseline">
                                    <MudText Typo="Typo.h4" Style="font-weight:800; letter-spacing:-0.5px;">@($"%{_emreamadelik:F1}")</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color:#1565c0; font-weight:600;">Sistem Verimi</MudText>
                            </div>
                            <div class="d-flex justify-end mt-2"><MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Color="Color.Default" Style="opacity:0.4;" /></div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard Elevation="4" Class="rounded-xl hover-effect h-100 position-relative overflow-hidden cursor-pointer" @onclick="@(() => NavManager.NavigateTo("/statistics"))">
                        <div class="stats-card-bg indigo-bg"></div>
                        <MudCardContent Class="d-flex flex-column justify-space-between h-100 pt-5 pb-3 px-5">
                            <div class="d-flex justify-space-between align-start mb-2">
                                <MudText Typo="Typo.subtitle1" Style="font-weight:600; color:#546e7a; z-index:1;">Gün Beklentisi</MudText>
                                <div class="pa-2 rounded-lg icon-box indigo-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.ShowChart" Size="Size.Medium" />
                                </div>
                            </div>
                            <div class="mt-4" style="z-index:1;">
                                <div class="d-flex align-baseline">
                                    <MudText Typo="Typo.h4" Style="font-weight:800; letter-spacing:-0.5px;">@($"{_gercekles:F0} / {_beklenen:F0}")</MudText>
                                    <MudText Typo="Typo.subtitle2" Class="ml-1 mud-text-secondary" Style="font-weight:600;">MW</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color:#283593; font-weight:600;">Gerçekleşen / Hedef</MudText>
                            </div>
                            <div class="d-flex justify-end mt-2"><MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Color="Color.Default" Style="opacity:0.4;" /></div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard Elevation="4" Class="rounded-xl hover-effect h-100 position-relative overflow-hidden cursor-pointer" @onclick="@(() => NavManager.NavigateTo("/turbines"))">
                        <div class="stats-card-bg cyan-bg"></div>
                        <MudCardContent Class="d-flex flex-column justify-space-between h-100 pt-5 pb-3 px-5">
                            <div class="d-flex justify-space-between align-start mb-2">
                                <MudText Typo="Typo.subtitle1" Style="font-weight:600; color:#546e7a; z-index:1;">Türbin Durumu</MudText>
                                <div class="pa-2 rounded-lg icon-box cyan-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.WindPower" Size="Size.Medium" />
                                </div>
                            </div>
                            <div class="mt-4" style="z-index:1;">
                                <div class="d-flex align-baseline">
                                    <MudText Typo="Typo.h4" Style="font-weight:800; letter-spacing:-0.5px;">@($"{_aktifTurbin} / {_toplamTurbin}")</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color:#00838f; font-weight:600;">Aktif Ünite</MudText>
                            </div>
                            <div class="d-flex justify-end mt-2"><MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Color="Color.Default" Style="opacity:0.4;" /></div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard Elevation="4" Class="rounded-xl hover-effect h-100 position-relative overflow-hidden cursor-pointer" @onclick="@(() => NavManager.NavigateTo("/statistics"))">
                        <div class="stats-card-bg purple-bg"></div>
                        <MudCardContent Class="d-flex flex-column justify-space-between h-100 pt-5 pb-3 px-5">
                            <div class="d-flex justify-space-between align-start mb-2">
                                <MudText Typo="Typo.subtitle1" Style="font-weight:600; color:#546e7a; z-index:1;">Önlenen Kayıp</MudText>
                                <div class="pa-2 rounded-lg icon-box purple-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.Shield" Size="Size.Medium" />
                                </div>
                            </div>
                            <div class="mt-4" style="z-index:1;">
                                <div class="d-flex align-baseline">
                                    <MudText Typo="Typo.h4" Style="font-weight:800; letter-spacing:-0.5px;">@_kayip.ToString("F1")</MudText>
                                    <MudText Typo="Typo.subtitle2" Class="ml-1 mud-text-secondary" Style="font-weight:600;">MW</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color:#6a1b9a; font-weight:600;">AI Optimizasyonu</MudText>
                            </div>
                            <div class="d-flex justify-end mt-2"><MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Color="Color.Default" Style="opacity:0.4;" /></div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard Elevation="4" Class="rounded-xl hover-effect h-100 position-relative overflow-hidden cursor-pointer" @onclick="@(() => NavManager.NavigateTo("/weather"))">
                        <div class="stats-card-bg orange-bg"></div>
                        <MudCardContent Class="d-flex flex-column justify-space-between h-100 pt-5 pb-3 px-5">
                            <div class="d-flex justify-space-between align-start mb-2">
                                <MudText Typo="Typo.subtitle1" Style="font-weight:600; color:#546e7a; z-index:1;">Hava Durumu</MudText>
                                <div class="pa-2 rounded-lg icon-box orange-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.Thermostat" Size="Size.Medium" />
                                </div>
                            </div>
                            <div class="mt-4" style="z-index:1;">
                                <div class="d-flex align-baseline">
                                    <MudText Typo="Typo.h4" Style="font-weight:800; letter-spacing:-0.5px;">@_havaDurumuDerece</MudText>
                                    <MudText Typo="Typo.subtitle2" Class="ml-1 mud-text-secondary" Style="font-weight:600;">@_havaDurumuDurum</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color:#ef6c00; font-weight:600;">Saha Tahmini</MudText>
                            </div>
                            <div class="d-flex justify-end mt-2"><MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Color="Color.Default" Style="opacity:0.4;" /></div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudCard Elevation="4" Class="rounded-xl hover-effect h-100 position-relative overflow-hidden cursor-pointer" @onclick="@(() => NavManager.NavigateTo("/reports"))">
                        <div class="stats-card-bg gray-bg"></div>
                        <MudCardContent Class="d-flex flex-column justify-space-between h-100 pt-5 pb-3 px-5">
                            <div class="d-flex justify-space-between align-start mb-2">
                                <MudText Typo="Typo.subtitle1" Style="font-weight:600; color:#546e7a; z-index:1;">Günlük Rapor</MudText>
                                <div class="pa-2 rounded-lg icon-box gray-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Medium" />
                                </div>
                            </div>
                            <div class="mt-4" style="z-index:1;">
                                <div class="d-flex align-baseline">
                                    <MudText Typo="Typo.h4" Style="font-weight:800; letter-spacing:-0.5px;">@_sonRaporDurumu</MudText>
                                </div>
                                <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color:#455a64; font-weight:600;">Otomatik Oluşturma</MudText>
                            </div>
                            <div class="d-flex justify-end mt-2"><MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Color="Color.Default" Style="opacity:0.4;" /></div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

            </MudGrid>
    }
</MudContainer>

<style>
    .hover-effect { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(0,0,0,0.04); }
    .hover-effect:hover { transform: translateY(-6px); box-shadow: 0 12px 24px rgba(0,0,0,0.1) !important; border-color:transparent; }

    .cursor-pointer { cursor: pointer; }

    /* Arka Plan Dekorları */
    .stats-card-bg {
        position: absolute;
        top: -50px;
        right: -50px;
        width: 140px;
        height: 140px;
        border-radius: 50%;
        opacity: 0.15;
        z-index: 0;
        pointer-events: none;
    }

    /* Renk Temaları (Gradient Arkaplanlar) */
    .red-bg { background: radial-gradient(circle, #f44336 0%, transparent 70%); }
    .green-bg { background: radial-gradient(circle, #4caf50 0%, transparent 70%); }
    .blue-bg { background: radial-gradient(circle, #2196f3 0%, transparent 70%); }
    .indigo-bg { background: radial-gradient(circle, #3f51b5 0%, transparent 70%); }
    .cyan-bg { background: radial-gradient(circle, #00bcd4 0%, transparent 70%); }
    .purple-bg { background: radial-gradient(circle, #9c27b0 0%, transparent 70%); }
    .orange-bg { background: radial-gradient(circle, #ff9800 0%, transparent 70%); }
    .gray-bg { background: radial-gradient(circle, #607d8b 0%, transparent 70%); }

    /* İkon Kutuları */
    .icon-box { display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .red-icon { background-color: #ffebee; color: #c62828; }
    .green-icon { background-color: #e8f5e9; color: #2e7d32; }
    .blue-icon { background-color: #e3f2fd; color: #1565c0; }
    .indigo-icon { background-color: #e8eaf6; color: #283593; }
    .cyan-icon { background-color: #e0f7fa; color: #00838f; }
    .purple-icon { background-color: #f3e5f5; color: #6a1b9a; }
    .orange-icon { background-color: #fff3e0; color: #ef6c00; }
    .gray-icon { background-color: #eceff1; color: #455a64; }
</style>

@code {
    private bool _loading = true;

    // Gösterilecek Veriler
    private int _riskliUyariSayisi = 0;
    private int _oneriSayisi = 0;
    private double _emreamadelik = 0;
    private double _beklenen = 0;
    private double _gercekles = 0;
    private double _kayip = 0;
    private int _toplamTurbin = 0;
    private int _aktifTurbin = 0;
    private string _havaDurumuDerece = "--";
    private string _havaDurumuDurum = "";
    private string _sonRaporDurumu = "Hazır";

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        try
        {
            // 1. Dashboard Verileri
            var dashboardData = await ApiService.GetDashboardAsync();
            if (dashboardData != null)
            {
                _riskliUyariSayisi = dashboardData.RiskliUyariSayisi;
                _oneriSayisi = dashboardData.ToplamOneriSayisi;
                _emreamadelik = dashboardData.VerimlilikYuzdesi;
                _toplamTurbin = dashboardData.ToplamTurbinSayisi;
                _aktifTurbin = dashboardData.AktifTurbinSayisi;
                _gercekles = dashboardData.ToplamUretimMW;

                if (dashboardData.BeklenenUretimSerisi != null)
                    _beklenen = dashboardData.BeklenenUretimSerisi.Sum();

                if (dashboardData.BeklenenUretimSerisi != null && dashboardData.GerceklesUretimSerisi != null)
                {
                    var count = Math.Min(dashboardData.BeklenenUretimSerisi.Count, dashboardData.GerceklesUretimSerisi.Count);
                    for (int i = 0; i < count; i++)
                    {
                        var fark = dashboardData.BeklenenUretimSerisi[i] - dashboardData.GerceklesUretimSerisi[i];
                        if (fark > 0) _kayip += fark;
                    }
                }
            }

            // 2. Hava Durumu
            var weather = await ApiService.GetWeatherForecastAsync();
            if (weather != null && weather.Any())
            {
                var today = weather.FirstOrDefault();
                if (today != null)
                {
                    _havaDurumuDerece = $"{today.Temperature}°C";
                    _havaDurumuDurum = today.Condition;
                }
            }

            // 3. Rapor Durumu
            var reports = await ApiService.GetReportsAsync();
            if (reports != null && reports.Any())
            {
                var lastReport = reports.OrderByDescending(r => r.GeneratedDate).FirstOrDefault();
                if (lastReport != null && lastReport.GeneratedDate.Date == DateTime.Today)
                    _sonRaporDurumu = "Güncel";
                else
                    _sonRaporDurumu = "Bekleniyor";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Stats yükleme hatası: " + ex.Message);
        }
        finally
        {
            _loading = false;
        }
    }
}
@page "/alerts"
@using WindTurbine.App.Services
@using WindTurbine.DTOs.Alerts
@using WindTurbine.DTOs.Turbines
@using MudBlazor
@inject IApiService ApiService
@inject ISnackbar Snackbar

<PageTitle>Akıllı Alarm Merkezi</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mb-6">

    <div class="d-flex justify-space-between align-center mb-6 flex-wrap gap-3">
        <div>
            <div class="d-flex align-center gap-2">
                <MudIcon Icon="@Icons.Material.Filled.NotificationsActive" Color="Color.Error" Size="Size.Large" />
                <MudText Typo="Typo.h4" Color="Color.Primary" Style="font-weight: 800;">Alarm Yönetimi</MudText>
            </div>
            <MudText Typo="Typo.body1" Class="mud-text-secondary mt-1">
                Yapay zeka destekli arıza tespiti ve müdahale önerileri.
            </MudText>
        </div>

        <div class="d-flex gap-2">
            <MudChip T="string" Color="Color.Error" Variant="Variant.Filled" OnClick="@(() => FilterAlerts("Critical"))">Kritik</MudChip>
            <MudChip T="string" Color="Color.Warning" Variant="Variant.Filled" OnClick="@(() => FilterAlerts("Warning"))">Uyarı</MudChip>
            <MudChip T="string" Color="Color.Default" Variant="Variant.Outlined" OnClick="@(() => FilterAlerts("All"))">Tümü</MudChip>
        </div>
    </div>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-6" />
        <MudText Align="Align.Center" Typo="Typo.h6" Class="mud-text-secondary">Alarmlar analiz ediliyor...</MudText>
    }
    else
    {
        <MudGrid>
            @foreach (var alert in _filteredAlerts)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudCard Elevation="4" Class="rounded-xl hover-effect h-100 position-relative overflow-hidden">

                        <div class="alert-card-bg" style="@GetBgStyle(alert.SeverityStr)"></div>

                        <MudCardHeader>
                            <CardHeaderContent>
                                <div class="d-flex justify-space-between w-100 align-start">

                                    <div>
                                        <div class="d-flex align-center gap-2 mb-1">
                                            @if (alert.SeverityStr == "Critical" || alert.SeverityStr == "Error")
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.ReportGmailerrorred" Color="Color.Error" />
                                                <MudText Typo="Typo.h6" Color="Color.Error" Style="font-weight:700;">KRİTİK</MudText>
                                            }
                                            else
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" />
                                                <MudText Typo="Typo.h6" Color="Color.Warning" Style="font-weight:700;">UYARI</MudText>
                                            }
                                        </div>
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@alert.Timestamp.ToString("dd.MM.yyyy HH:mm")</MudText>
                                    </div>

                                    <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small" Style="font-weight:bold; border-width:2px;">
                                        @GetTurbineName(alert.TurbineId)
                                    </MudChip>

                                </div>
                            </CardHeaderContent>
                        </MudCardHeader>

                        <MudCardContent Class="py-2">

                            <MudText Typo="Typo.subtitle1" Style="font-weight:600; min-height:50px;">
                                @alert.Message
                            </MudText>

                            <MudDivider Class="my-3" />

                            <div class="d-flex gap-3">
                                <MudIcon Icon="@Icons.Material.Filled.Psychology" Color="Color.Info" Size="Size.Medium" />
                                <div>
                                    <div class="d-flex justify-space-between align-center w-100 mb-1">
                                        <MudText Typo="Typo.caption" Style="font-weight:800; color:#1565c0; letter-spacing:0.5px;">AI GÜVEN ORANI</MudText>
                                        <MudText Typo="Typo.caption" Style="font-weight:800; color:#1565c0;">%@((alert.Confidence * 100).ToString("F0"))</MudText>
                                    </div>

                                    <MudProgressLinear Color="@GetConfidenceColor(alert.Confidence)" Value="@(alert.Confidence * 100)" Class="mb-2 rounded" Style="height:6px;" />

                                    <MudText Typo="Typo.caption" Style="font-weight:800; color:#e65100; letter-spacing:0.5px;">ÖNERİLEN AKSİYON:</MudText>
                                    <MudText Typo="Typo.body2" Style="line-height:1.3; font-weight:500;">
                                        @GetAiRecommendation(alert.Message, alert.SeverityStr)
                                    </MudText>
                                </div>
                            </div>

                        </MudCardContent>

                        <MudCardActions Class="px-4 pb-4 pt-2">
                            <MudButton Variant="Variant.Filled"
                                       Color="@GetButtonColor(alert.SeverityStr)"
                                       FullWidth="true"
                                       OnClick="@(() => OnayAl(alert))"
                                       StartIcon="@Icons.Material.Filled.Build">
                                @(alert.Status == "Active" ? "Müdahale Başlat" : "Tamamlandı")
                            </MudButton>
                        </MudCardActions>

                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<style>
    .hover-effect {
        transition: all 0.3s ease;
    }

        .hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15) !important;
        }

    .alert-card-bg {
        position: absolute;
        top: -40px;
        right: -40px;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        opacity: 0.1;
        z-index: 0;
        pointer-events: none;
    }
</style>

@code {
    private List<AlertViewModel> _allAlerts = new();
    private List<AlertViewModel> _filteredAlerts = new();
    private List<TurbineDto> _turbines = new();
    private bool _loading = true;

    // Arayüz için genişletilmiş Model
    public class AlertViewModel : AlertDto
    {
        public string SeverityStr => Severity == 1 ? "Error" : "Warning"; // 1: Error, 2: Warning
    }

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        try
        {
            // 1. Türbinleri Çek (İsim Eşleşmesi İçin)
            _turbines = await ApiService.GetTurbinesAsync() ?? new List<TurbineDto>();

            // 2. Alarmları Çek
            var alerts = await ApiService.GetAlertsAsync();
            if (alerts != null)
            {
                // DTO'yu ViewModele çevir ve ters sırala (En yeni en üstte)
                _allAlerts = alerts.Select(a => new AlertViewModel
                    {
                        AlertId = a.AlertId,
                        Message = a.Message,
                        Severity = a.Severity,
                        Timestamp = a.Timestamp,
                        TurbineId = a.TurbineId,
                        Confidence = a.Confidence,
                        Status = a.Status
                    }).OrderByDescending(a => a.Timestamp).ToList();

                _filteredAlerts = _allAlerts;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Veri hatası: " + ex.Message, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    // --- YARDIMCI METOTLAR ---

    private string GetTurbineName(int turbineId)
    {
        var t = _turbines.FirstOrDefault(x => x.TurbineId == turbineId);
        return t != null ? t.Name : $"T-{turbineId:00}";
    }

    private void FilterAlerts(string type)
    {
        if (type == "All")
            _filteredAlerts = _allAlerts;
        else if (type == "Critical")
            _filteredAlerts = _allAlerts.Where(x => x.SeverityStr == "Critical" || x.SeverityStr == "Error").ToList();
        else
            _filteredAlerts = _allAlerts.Where(x => x.SeverityStr == "Warning").ToList();
    }

    private string GetBgStyle(string severity)
    {
        if (severity == "Critical" || severity == "Error")
            return "background: radial-gradient(circle, #f44336 0%, rgba(255,255,255,0) 70%);";

        return "background: radial-gradient(circle, #ff9800 0%, rgba(255,255,255,0) 70%);";
    }

    private Color GetButtonColor(string severity)
    {
        return (severity == "Critical" || severity == "Error") ? Color.Error : Color.Warning;
    }

    private Color GetConfidenceColor(double conf)
    {
        if (conf > 0.85) return Color.Success;
        if (conf > 0.60) return Color.Warning;
        return Color.Error;
    }

    // --- YAPAY ZEKA YORUM MANTIĞI ---
    private string GetAiRecommendation(string message, string severity)
    {
        if (message.Contains("Sıcaklık") || message.Contains("Temperature"))
            return "Soğutma sistemini kontrol edin ve yükü %20 azaltın. Yağ seviyesi sensörlerini doğrulayın.";

        if (message.Contains("Titreşim") || message.Contains("Vibration"))
            return "Rulman yataklarında aşınma ihtimali yüksek (%89). Acil durdurma ve fiziksel inceleme önerilir.";

        if (message.Contains("Yağ") || message.Contains("Oil"))
            return "Sızıntı tespit edildi. Basınç valflerini kapatın ve bakım ekibini yönlendirin.";

        if (message.Contains("Voltaj") || message.Contains("Voltage"))
            return "Şebeke dalgalanması algılandı. İnvertör ayarlarını kontrol edin, reaktif güç dengesini sağlayın.";

        // Varsayılan öneriler
        if (severity == "Critical" || severity == "Error")
            return "Kritik arıza. Türbini güvenli moda alın ve saha ekibine acil iş emri oluşturun.";

        return "Sistemi izlemeye devam edin. Tekrarlarsa bakım planına ekleyin.";
    }

    private void OnayAl(AlertViewModel alert)
    {
        Snackbar.Add($"Alarm ID: {alert.AlertId} için müdahale başlatıldı.", Severity.Success);
        // Burada veritabanı güncelleme işlemi yapılabilir.
    }
}
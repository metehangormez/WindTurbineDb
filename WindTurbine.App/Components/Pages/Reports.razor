@page "/reports"
@using WindTurbine.App.Services
@using WindTurbine.DTOs.Reports
@using WindTurbine.DTOs.Turbines
@using WindTurbine.DTOs.Alerts
@using ClosedXML.Excel
@using System.IO
@inject IApiService ApiService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>Raporlar</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6 mb-6">

    <div class="d-flex justify-content-between align-items-center mb-6">
        <div>
            <MudText Typo="Typo.h5" Color="Color.Primary" Style="font-weight: 700;">Rapor Merkezi</MudText>
            <MudText Typo="Typo.body2" Class="mud-text-secondary">Sistem performans ve arıza raporları</MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.PostAdd"
                   Color="Color.Primary"
                   OnClick="YeniRaporOlusturVeIndir"
                   Disabled="@yukleniyor">
            @(yukleniyor ? "Oluşturuluyor..." : "Yeni Rapor Oluştur (Excel)")
        </MudButton>
    </div>

    <MudTable Items="@reports" Hover="true" Elevation="3" Class="rounded-lg">
        <HeaderContent>
            <MudTh>Dosya Tipi</MudTh>
            <MudTh>Rapor Adı</MudTh>
            <MudTh>Tarih</MudTh>
            <MudTh>Boyut</MudTh>
            <MudTh>Durum</MudTh>
            <MudTh Style="text-align:right">İşlem</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Tip">
                @if (context.FileType == "PDF")
                {
                    <MudIcon Icon="@Icons.Material.Filled.PictureAsPdf" Color="Color.Error" Size="Size.Medium" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.TableView" Color="Color.Success" Size="Size.Medium" />
                }
            </MudTd>
            <MudTd DataLabel="Ad">
                <MudText Typo="Typo.body1" Style="font-weight: 600;">@context.Title</MudText>
            </MudTd>
            <MudTd DataLabel="Tarih">@context.GeneratedDate.ToString("dd.MM.yyyy HH:mm")</MudTd>
            <MudTd DataLabel="Boyut">@context.FileSize</MudTd>
            <MudTd DataLabel="Durum">
                <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Text">Hazır</MudChip>
            </MudTd>
            <MudTd DataLabel="İşlem" Style="text-align:right">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Download"
                           OnClick="@(() => RaporIndir(context))">İndir</MudButton>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Typo="Typo.body2" Class="pa-4">Henüz rapor bulunmuyor.</MudText>
        </NoRecordsContent>
    </MudTable>

</MudContainer>

@code {
    private List<ReportDto> reports = new List<ReportDto>();
    private bool yukleniyor = false;

    protected override async Task OnInitializedAsync()
    {
        
        try
        {
            var mevcutRaporlar = await ApiService.GetReportsAsync();
            if (mevcutRaporlar != null)
            {
                reports = mevcutRaporlar.OrderByDescending(r => r.GeneratedDate).ToList();
            }
        }
        catch { }
    }

    private async Task YeniRaporOlusturVeIndir()
    {
        yukleniyor = true;
        try
        {
            Snackbar.Add("Rapor hazırlanıyor...", Severity.Info);

          
            var turbinler = await ApiService.GetTurbinesAsync();
            var alarmlar = await ApiService.GetAlertsAsync();

          
            byte[] excelContent;
            using (var workbook = new XLWorkbook())
            {
                var ws1 = workbook.Worksheets.Add("Türbinler");
                ws1.Cell(1, 1).Value = "TÜRBİN DURUM RAPORU";
                ws1.Range(1, 1, 1, 4).Merge().Style.Font.Bold = true;

                int row = 2;
                foreach (var t in turbinler)
                {
                    ws1.Cell(row, 1).Value = t.Name;
                    ws1.Cell(row, 2).Value = t.LastStatus;
                    ws1.Cell(row, 3).Value = t.CurrentPower;
                    row++;
                }

                using (var stream = new MemoryStream())
                {
                    workbook.SaveAs(stream);
                    excelContent = stream.ToArray();
                }
            }

        
            using (var streamRef = new DotNetStreamReference(stream: new MemoryStream(excelContent)))
            {
                string dosyaAdi = $"Sistem_Raporu_{DateTime.Now:yyyyMMdd_HHmm}.xlsx";
                await JS.InvokeVoidAsync("downloadFileFromStream", dosyaAdi, streamRef);
            }

         
            var yeniRapor = new ReportDto
                {
                    ReportId = new Random().Next(1000, 9999),
                    Title = $"Sistem Durum Raporu - {DateTime.Now:HH:mm}",
                    GeneratedDate = DateTime.Now,
                    FileType = "Excel",
                    FileSize = $"{excelContent.Length / 1024} KB",
                    Status = "Hazır"
                };

            reports.Insert(0, yeniRapor); 
            StateHasChanged(); 

            Snackbar.Add("Rapor oluşturuldu ve listeye eklendi.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Hata: " + ex.Message, Severity.Error);
        }
        finally
        {
            yukleniyor = false;
        }
    }

    private async Task RaporIndir(ReportDto rapor)
    {
        
        if (rapor.FileType == "Excel")
        {
           
            Snackbar.Add($"'{rapor.Title}' tekrar indiriliyor...", Severity.Info);
            await YeniRaporOlusturVeIndir(); 
        }
        else
        {
            Snackbar.Add("Bu eski bir PDF raporu, indirme simülasyonu.", Severity.Info);
        }
    }
}
@page "/"
@layout WindTurbine.App.Components.Layout.AuthLayout
@using WindTurbine.DTOs.Auth
@using WindTurbine.App.Services  
@using System.ComponentModel.DataAnnotations
@using Microsoft.Maui.Storage 
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inject IApiService ApiService 
@inject UserSession UserSession

<PageTitle>Giriş Yap</PageTitle>

<MudGrid Class="h-100" Spacing="0">
    <MudItem xs="12" md="6" Class="d-none d-md-flex align-center justify-center"
             Style="background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%); height: 100vh;">
        <div class="d-flex flex-column align-center text-center px-4">

            <MudImage Src="images/logo.png"
                      Alt="Wind Manager Logo"
                      Elevation="0"
                      Class="mb-4"
                      Style="width: 250px; max-width: 80%; height: auto;" />

            <MudText Typo="Typo.h3" Class="mt-4 mb-2" Style="color: white; font-weight: 800;">WIND MANAGER</MudText>
            <MudText Typo="Typo.h6" Style="color: rgba(255,255,255,0.7);">Akıllı SCADA Takip Sistemi</MudText>
        </div>
    </MudItem>

    <MudItem xs="12" md="6" Class="d-flex align-center justify-center pa-8" Style="height: 100vh; background-color: white;">
        <div style="width: 100%; max-width: 400px;">
            <MudText Typo="Typo.h4" Color="Color.Primary" Style="font-weight: 700;">Hoş Geldiniz</MudText>
            <MudText Typo="Typo.body1" Class="mud-text-secondary mb-8">Hesabınıza giriş yapın</MudText>

            <MudForm @ref="form" @bind-IsValid="@success">
                <MudTextField T="string" 
                              Label="E-Posta" 
                              Variant="Variant.Outlined" 
                              @bind-Value="loginDto.Email"
                              Required="true"
                              RequiredError="E-posta gereklidir!"
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Email" 
                              Class="mb-4"/>

                <MudTextField T="string"
                              Label="Şifre" 
                              Variant="Variant.Outlined" 
                              @bind-Value="loginDto.Password"
                              InputType="InputType.Password"
                              Required="true"
                              RequiredError="Şifre gereklidir!"
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Lock" 
                              Class="mb-2"/>

                <div class="d-flex justify-space-between align-center mb-6">
                    <MudCheckBox T="bool" @bind-Value="beniHatirla" Label="Beni Hatırla" Color="Color.Primary" Dense="true" />

                    <MudLink OnClick="@SifremiUnuttum" Underline="Underline.None" Color="Color.Primary" Typo="Typo.body2" Style="cursor: pointer;">Şifremi Unuttum?</MudLink>
                </div>

                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           Size="Size.Large" 
                           FullWidth="true" 
                           OnClick="GirisYap" 
                           Class="mb-6 py-3"
                           Disabled="@(!success)"
                           Style="font-weight: bold;">GİRİŞ YAP</MudButton>
            </MudForm>

            <div class="d-flex justify-center">
                <MudText Typo="Typo.body2">Hesabınız yok mu? <MudLink Href="/register" Color="Color.Primary" Underline="Underline.None"><b>Kayıt Ol</b></MudLink></MudText>
            </div>
        </div>
    </MudItem>
</MudGrid>

@code {
    bool success;
    MudForm form;
    UserLoginDto loginDto = new UserLoginDto();
    bool beniHatirla = false;

    protected override async Task OnInitializedAsync()
    {
       
        if (Preferences.ContainsKey("SavedEmail"))
        {
            loginDto.Email = Preferences.Get("SavedEmail", "");
            beniHatirla = true;
        }
    }

    private async Task GirisYap()
    {
        form.Validate();
        if (success)
        {
        
            var sonuc = await ApiService.LoginAsync(loginDto);

            if (sonuc)
            {
               
                UserSession.Email = loginDto.Email;
                UserSession.FullName = "Metehan Görmez";
                UserSession.Role = "Admin";

              
                if (beniHatirla)
                {
                    Preferences.Set("SavedEmail", loginDto.Email);
                }
                else
                {
                    Preferences.Remove("SavedEmail");
                }

                Snackbar.Add("Giriş Başarılı!", Severity.Success);
                NavManager.NavigateTo("/dashboard");
            }
            else
            {
                Snackbar.Add("E-posta veya şifre hatalı!", Severity.Error);
            }
        }
    }

    // Şifremi Unuttum Butonu
    private void SifremiUnuttum()
    {
        Snackbar.Add("Lütfen sistem yöneticinizle iletişime geçin.", Severity.Info);
    }
}
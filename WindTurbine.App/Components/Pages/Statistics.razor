@page "/statistics"
@using WindTurbine.App.Services
@using WindTurbine.DTOs.Dashboard
@using MudBlazor
@inject IApiService ApiService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>İstatistikler ve Emreamadelik</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6 mb-6">

    <div class="d-flex align-center mb-6">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       Color="Color.Inherit"
                       OnClick="@(() => NavManager.NavigateTo("/dashboard"))"
                       Class="mr-3" />
        <div>
            <MudText Typo="Typo.h4" Color="Color.Primary"><b>Emreamadelik Analizi</b></MudText>
            <MudText Typo="Typo.body2" Class="mud-text-secondary">Detaylı üretim ve kayıp raporları</MudText>
        </div>
    </div>

    @if (loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else
    {
        <!-- Üst kartlar -->
        <MudGrid Class="mb-8">
            <MudItem xs="12" sm="4">
                <MudPaper Elevation="0"
                          Class="pa-4 rounded-lg border-solid border-1 mud-border-lines-default d-flex flex-column align-center justify-center"
                          Style="height: 140px;">
                    <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">BEKLENEN ÜRETİM</MudText>
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.ShowChart" Color="Color.Info" Class="mr-2" />
                        <MudText Typo="Typo.h4" Color="Color.Info">
                            <b>@TotalBeklenen.ToString("F1")</b> <span style="font-size:0.6em">MW</span>
                        </MudText>
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Elevation="0"
                          Class="pa-4 rounded-lg border-solid border-1 mud-border-lines-default d-flex flex-column align-center justify-center"
                          Style="height: 140px; border-bottom: 4px solid #ff9800;">
                    <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">GERÇEKLEŞEN ÜRETİM</MudText>
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.Bolt" Color="Color.Warning" Class="mr-2" />
                        <MudText Typo="Typo.h4" Color="Color.Warning">
                            <b>@dashboardData.ToplamUretimMW.ToString("F1")</b> <span style="font-size:0.6em">MW</span>
                        </MudText>
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Elevation="0"
                          Class="pa-4 rounded-lg border-solid border-1 mud-border-lines-default d-flex flex-column align-center justify-center"
                          Style="height: 140px;">
                    <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">GÜN SONU TAHMİNİ</MudText>
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.Flag" Color="Color.Success" Class="mr-2" />
                        <MudText Typo="Typo.h4" Color="Color.Success">
                            <b>@GunSonuTahmini.ToString("F1")</b> <span style="font-size:0.6em">MW</span>
                        </MudText>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Grafik + tablo -->
        <MudPaper Elevation="0" Class="pa-6 rounded-lg border-solid border-1 mud-border-lines-default">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6"><b>Üretim Karşılaştırması (Saatlik)</b></MudText>
                <div class="d-flex gap-4">
                    <div class="d-flex align-center">
                        <div style="width: 16px; height: 16px; background-color: rgba(33, 150, 243, 0.3); border-radius: 4px; margin-right: 8px;"></div>
                        <MudText Typo="Typo.caption">Beklenen (Kayıp)</MudText>
                    </div>
                    <div class="d-flex align-center">
                        <div style="width: 16px; height: 16px; background-color: #ff9800; border-radius: 4px; margin-right: 8px;"></div>
                        <MudText Typo="Typo.caption">Gerçekleşen (Üretim)</MudText>
                    </div>
                </div>
            </div>

            <!-- Bar chart -->
            <MudChart ChartType="ChartType.Bar"
                      ChartSeries="@Series"
                      XAxisLabels="@XAxisLabels"
                      Width="100%"
                      Height="350px"
                      ChartOptions="@chartOptions" />

            <!-- Altında sayısal tablo -->
            <MudDivider Class="my-4" />

            <MudText Typo="Typo.subtitle2" Class="mb-2"><b>Saatlik Değerler</b></MudText>

            <MudTable Items="HourlyRows" Dense="true" Hover="true">
                <HeaderContent>
                    <MudTh>Saat</MudTh>
                    <MudTh>Gerçekleşen (MW)</MudTh>
                    <MudTh>Beklenen (MW)</MudTh>
                    <MudTh>Kayıp / Fark (MW)</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Saat">@context.Label</MudTd>
                    <MudTd DataLabel="Gerçekleşen">@context.Gercekles.ToString("F1")</MudTd>
                    <MudTd DataLabel="Beklenen">@context.Beklenen.ToString("F1")</MudTd>
                    <MudTd DataLabel="Kayıp / Fark">@context.Fark.ToString("F1")</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }

</MudContainer>

@code {
    private DashboardDto dashboardData = new();
    private bool loading = true;

    // Grafik verileri
    public List<ChartSeries> Series = new();
    public string[] XAxisLabels = Array.Empty<string>();

    // Kart hesaplamaları
    private double TotalBeklenen = 0;
    private double GunSonuTahmini = 0;

    // Saatlik tablo verisi
    private List<HourlyRow> HourlyRows = new();

    // Grafik ayarları
    private ChartOptions chartOptions = new ChartOptions()
        {
            YAxisLines = true,
            ChartPalette = new string[] { "#ff9800", "rgba(33, 150, 243, 0.3)" }
        };

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        try
        {
            var data = await ApiService.GetDashboardAsync();
            if (data is null)
            {
                loading = false;
                return;
            }

            dashboardData = data;

            var gercekles = data.GerceklesUretimSerisi ?? new List<double>();
            var beklenen = data.BeklenenUretimSerisi ?? new List<double>();
            var labels = data.SaatEtiketleri ?? new List<string>();

            int count = Math.Min(gercekles.Count, beklenen.Count);
            if (count == 0)
            {
                Series.Clear();
                XAxisLabels = Array.Empty<string>();
                HourlyRows.Clear();
                TotalBeklenen = 0;
                GunSonuTahmini = 0;
                return;
            }

            // Etiketleri güvenli uzunlukta al
            XAxisLabels = labels.Take(count).ToArray();

            // 1. seri: Gerçekleşen
            var series1Data = gercekles.Take(count).ToArray();
            var series1 = new ChartSeries { Name = "Gerçekleşen", Data = series1Data };

            // 2. seri: Kayıp/Fark (Beklenen - Gerçekleşen)
            var farkData = new double[count];
            HourlyRows = new List<HourlyRow>(count);

            for (int i = 0; i < count; i++)
            {
                double g = gercekles[i];
                double b = beklenen[i];
                double fark = b - g;
                if (fark < 0) fark = 0; // negatif olmasın

                farkData[i] = fark;

                string label = (i < labels.Count) ? labels[i] : $"T{i}";
                HourlyRows.Add(new HourlyRow
                    {
                        Label = label,
                        Gercekles = g,
                        Beklenen = b,
                        Fark = b - g   // tabloda gerçek farkı göster
                    });
            }

            var series2 = new ChartSeries { Name = "Kayıp/Fark", Data = farkData };

            Series.Clear();
            Series.Add(series1);
            Series.Add(series2);

            // Kart verileri
            TotalBeklenen = beklenen.Take(count).Sum();
            GunSonuTahmini = TotalBeklenen * 1.1; // basit tahmin
        }
        catch (Exception ex)
        {
            Snackbar.Add("Veri hatası: " + ex.Message, Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private class HourlyRow
    {
        public string Label { get; set; } = "";
        public double Gercekles { get; set; }
        public double Beklenen { get; set; }
        public double Fark { get; set; }
    }
}

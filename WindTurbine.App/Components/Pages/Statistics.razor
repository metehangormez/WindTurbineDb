@page "/statistics"
@using WindTurbine.App.Services
@using WindTurbine.DTOs.Dashboard
@using MudBlazor
@inject IApiService ApiService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>İstatistikler ve Emreamadelik</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6 mb-6">

    <div class="d-flex align-center mb-6">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       Color="Color.Inherit"
                       OnClick='@(() => NavManager.NavigateTo("/dashboard"))'
                       Class="mr-3" />
        <div>
            <MudText Typo="Typo.h4" Color="Color.Primary"><b>Emreamadelik Analizi</b></MudText>
            <MudText Typo="Typo.body2" Class="mud-text-secondary">Detaylı üretim ve kayıp raporları</MudText>
        </div>
    </div>

    @if (loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else
    {
        <MudGrid Class="mb-8">
            <MudItem xs="12" sm="4">
                <MudPaper Elevation="0" Class="pa-4 rounded-lg border-solid border-1 mud-border-lines-default d-flex flex-column align-center justify-center" Style="height: 140px;">
                    <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">BEKLENEN ÜRETİM</MudText>
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.ShowChart" Color="Color.Info" Class="mr-2" />
                        <MudText Typo="Typo.h4" Color="Color.Info">
                            <b>@TotalBeklenen.ToString("F1")</b> <span style="font-size:0.6em">MW</span>
                        </MudText>
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Elevation="0" Class="pa-4 rounded-lg border-solid border-1 mud-border-lines-default d-flex flex-column align-center justify-center" Style="height: 140px; border-bottom: 4px solid #ff9800;">
                    <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">GERÇEKLEŞEN ÜRETİM</MudText>
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.Bolt" Color="Color.Warning" Class="mr-2" />
                        <MudText Typo="Typo.h4" Color="Color.Warning">
                            <b>@dashboardData.ToplamUretimMW</b> <span style="font-size:0.6em">MW</span>
                        </MudText>
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Elevation="0" Class="pa-4 rounded-lg border-solid border-1 mud-border-lines-default d-flex flex-column align-center justify-center" Style="height: 140px;">
                    <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-1">GÜN SONU TAHMİNİ</MudText>
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.Flag" Color="Color.Success" Class="mr-2" />
                        <MudText Typo="Typo.h4" Color="Color.Success">
                            <b>@GunSonuTahmini.ToString("F1")</b> <span style="font-size:0.6em">MW</span>
                        </MudText>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudPaper Elevation="0" Class="pa-6 rounded-lg border-solid border-1 mud-border-lines-default">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6"><b>Üretim Karşılaştırması (Saatlik)</b></MudText>
                <div class="d-flex gap-4">
                    <div class="d-flex align-center">
                        <div style="width: 16px; height: 16px; background-color: rgba(33, 150, 243, 0.3); border-radius: 4px; margin-right: 8px;"></div>
                        <MudText Typo="Typo.caption">Beklenen (Kayıp)</MudText>
                    </div>
                    <div class="d-flex align-center">
                        <div style="width: 16px; height: 16px; background-color: #ff9800; border-radius: 4px; margin-right: 8px;"></div>
                        <MudText Typo="Typo.caption">Gerçekleşen (Üretim)</MudText>
                    </div>
                </div>
            </div>

            <MudChart ChartType="ChartType.Bar"
                      ChartSeries="@Series"
                      XAxisLabels="@XAxisLabels"
                      Width="100%"
                      Height="400px"
                      ChartOptions="@chartOptions"
                      />
        </MudPaper>
    }

</MudContainer>

@code {
    private DashboardDto dashboardData = new();
    private bool loading = true;

    // Grafik Verileri
    public List<ChartSeries> Series = new();
    public string[] XAxisLabels = Array.Empty<string>();

    // Kart Hesaplamaları
    private double TotalBeklenen = 0;
    private double GunSonuTahmini = 0;

    // Grafik Ayarları
    private ChartOptions chartOptions = new ChartOptions()
        {
            YAxisLines = true,
            ChartPalette = new string[] { "#ff9800", "rgba(33, 150, 243, 0.3)" }
        };

    protected override async Task OnInitializedAsync()
    {
        loading = true;
        try
        {
            var data = await ApiService.GetDashboardAsync();
            if (data is null)
            {
                loading = false;
                return;
            }

            dashboardData = data;

            // Güvenli koleksiyon al
            var gercekles = data.GerceklesUretimSerisi ?? new List<double>();
            var beklenen = data.BeklenenUretimSerisi ?? new List<double>();
            var labels = data.SaatEtiketleri ?? new List<string>();

            int count = Math.Min(gercekles.Count, beklenen.Count);

            if (count == 0)
            {
                Series.Clear();
                XAxisLabels = Array.Empty<string>();
                TotalBeklenen = 0;
                GunSonuTahmini = 0;
                return;
            }

            // Label sayısını da güvenli tut
            XAxisLabels = labels.Take(count).ToArray();

            // 1. Seri: Gerçekleşen
            var series1Data = gercekles.Take(count).ToArray();
            var series1 = new ChartSeries { Name = "Gerçekleşen", Data = series1Data };

            // 2. Seri: Beklenen - Gerçekleşen (kayıp/fark)
            var farkData = new double[count];
            for (int i = 0; i < count; i++)
            {
                double b = beklenen[i];
                double g = gercekles[i];
                double fark = b - g;
                farkData[i] = fark > 0 ? fark : 0;
            }
            var series2 = new ChartSeries { Name = "Kayıp/Fark", Data = farkData };

            Series.Clear();
            Series.Add(series1);
            Series.Add(series2);

            // Kart Verileri
            TotalBeklenen = beklenen.Take(count).Sum();
            GunSonuTahmini = TotalBeklenen * 1.1; // örnek tahmin mantığı
        }
        catch (Exception ex)
        {
            Snackbar.Add("Veri hatası: " + ex.Message, Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }
}

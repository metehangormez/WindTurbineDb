@page "/"
@using WindTurbine.App.Services
@using WindTurbine.DTOs.Alerts
@inject IApiService ApiService

<PageTitle>Rüzgar SCADA Paneli</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <MudText Typo="Typo.h4" Color="Color.Primary"><b>Ana Sayfa</b></MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh" OnClick="VerileriYukle">Yenile</MudButton>
    </div>

    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4" Style="background-color: #ffebee; border-left: 5px solid #f44336;">
                <MudText Typo="Typo.subtitle1">Riskli Uyarılar</MudText>
                <MudText Typo="Typo.h4" Color="Color.Error"><b>@riskliSayisi</b></MudText>
                <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small">Uyarıları Gör</MudButton>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4" Style="background-color: #e8f5e9; border-left: 5px solid #4caf50;">
                <MudText Typo="Typo.subtitle1">Öneriler</MudText>
                <MudText Typo="Typo.h4" Color="Color.Success"><b>89</b></MudText>
                <MudButton Variant="Variant.Text" Color="Color.Success" Size="Size.Small">Türbinleri İncele</MudButton>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4" Style="background-color: #ede7f6; border-left: 5px solid #673ab7;">
                <MudText Typo="Typo.subtitle1">Emreamadelik</MudText>
                <MudText Typo="Typo.h4" Color="Color.Primary"><b>98%</b></MudText>
                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small">Detayları İncele</MudButton>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4" Style="background-color: #fff3e0; border-left: 5px solid #ff9800;">
                <MudText Typo="Typo.subtitle1">Toplam Üretim</MudText>
                <MudText Typo="Typo.h4" Color="Color.Warning"><b>625 MW</b></MudText>
                <MudButton Variant="Variant.Text" Color="Color.Warning" Size="Size.Small">Detaylar</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudText Typo="Typo.h5" Class="mb-2"><b>Canlı Alarm Akışı</b></MudText>

    <MudDataGrid T="AlertDto" Items="@alerts" Filterable="true" SortMode="SortMode.Multiple" Groupable="true">
        <Columns>
            <PropertyColumn Property="x => x.AlertId" Title="ID" />

            <PropertyColumn Property="x => x.Timestamp" Title="Zaman">
                <CellTemplate>
                    @context.Item.Timestamp.ToLocalTime().ToString("dd.MM.yyyy HH:mm:ss")
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn Property="x => x.Message" Title="Mesaj" />

            <PropertyColumn Property="x => x.Severity" Title="Seviye">
                <CellTemplate>
                    @if (context.Item.Severity >= 3)
                    {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small">Kritik</MudChip>
                    }
                    else if (context.Item.Severity == 2)
                    {
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small">Orta</MudChip>
                    }
                    else
                    {
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">Düşük</MudChip>
                    }
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn Property="x => x.Confidence" Title="AI Güveni">
                <CellTemplate>
                    <MudProgressLinear Color="Color.Success" Value="@((double)(context.Item.Confidence * 100))" Class="my-3" />
                    <MudText Typo="Typo.caption">@((context.Item.Confidence * 100).ToString("F0"))%</MudText>
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn Property="x => x.Status" Title="Durum" />
        </Columns>

        <PagerContent>
            <MudDataGridPager T="AlertDto" />
        </PagerContent>
    </MudDataGrid>

</MudContainer>

@code {
    private List<AlertDto> alerts = new List<AlertDto>();
    private int riskliSayisi = 0;

    protected override async Task OnInitializedAsync()
    {
        await VerileriYukle();
    }

    private async Task VerileriYukle()
    {
        // API'den verileri çek
        alerts = await ApiService.GetAlertsAsync();

        // İstatistikleri hesapla
        riskliSayisi = alerts.Count(a => a.Severity >= 3);
    }
}
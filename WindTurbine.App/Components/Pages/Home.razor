@page "/"
@using WindTurbine.App.Services
@using WindTurbine.DTOs.Alerts
@inject IApiService ApiService
@inject ISnackbar Snackbar
@page "/dashboard"
<PageTitle>Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-8">

    <div class="d-flex justify-content-between align-items-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #2c3e50;">Ana Sayfa</MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="VerileriYukle"
                   Disabled="@yukleniyor">
            @(yukleniyor ? "Yükleniyor..." : "Yenile")
        </MudButton>
    </div>

    <MudGrid Class="mb-6">

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg d-flex flex-column justify-space-between" Style="background-color: #ffebee; height: 180px;">
                <div class="d-flex justify-space-between">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Error">Riskli Uyarılar</MudText>
                        <MudText Typo="Typo.h3" Color="Color.Error" Style="font-weight: 700;">@riskliSayisi</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Large" />
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small" FullWidth="true" Class="mt-2">Uyarıları Gör</MudButton>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg d-flex flex-column justify-space-between" Style="background-color: #e8f5e9; height: 180px;">
                <div class="d-flex justify-space-between">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Success">Öneriler</MudText>
                        <MudText Typo="Typo.h3" Color="Color.Success" Style="font-weight: 700;">89</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Color="Color.Success" Size="Size.Large" />
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" FullWidth="true" Class="mt-2">Türbinleri İncele</MudButton>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg d-flex flex-column justify-space-between" Style="background-color: #ede7f6; height: 180px;">
                <div class="d-flex justify-space-between">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary">Emreamadelik</MudText>
                        <MudText Typo="Typo.h3" Color="Color.Primary" Style="font-weight: 700;">98%</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Speed" Color="Color.Primary" Size="Size.Large" />
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" FullWidth="true" Class="mt-2">Detayları İncele</MudButton>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg d-flex flex-column justify-space-between" Style="background-color: #fff3e0; height: 180px;">
                <div class="d-flex justify-space-between">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Warning">Toplam Üretim</MudText>
                        <MudText Typo="Typo.h3" Color="Color.Warning" Style="font-weight: 700;">625 MW</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Bolt" Color="Color.Warning" Size="Size.Large" />
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Warning" Size="Size.Small" FullWidth="true" Class="mt-2">Detaylar</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mb-6">
        <MudItem xs="12" md="8">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg border-solid border-1 mud-border-lines-default">
                <MudText Typo="Typo.h6" Class="mb-4"><b>Gün Beklentisi (MW)</b></MudText>
                <MudChart ChartType="ChartType.Bar"
                          ChartSeries="@SeriesExpectation"
                          XAxisLabels="@XAxisLabels"
                          Width="100%"
                          Height="300px"></MudChart>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="0" Class="pa-4 rounded-lg border-solid border-1 mud-border-lines-default">
                <MudText Typo="Typo.h6" Class="mb-4"><b>Önlenen Kayıp (MW)</b></MudText>
                <MudChart ChartType="ChartType.Bar"
                          ChartSeries="@SeriesLoss"
                          XAxisLabels="@XAxisLabelsLoss"
                          Width="100%"
                          Height="300px"></MudChart>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="0" Class="pa-0 rounded-lg border-solid border-1 mud-border-lines-default overflow-hidden">
        <div class="pa-4 border-b-1 mud-border-lines-default">
            <MudText Typo="Typo.h6"><b>Canlı Alarm Akışı</b></MudText>
        </div>

        <MudTable Items="@alerts"
                  Context="alert"
                  Hover="true"
                  Elevation="0"
                  Loading="@yukleniyor"
                  LoadingProgressColor="Color.Primary"
                  Dense="true"
                  Striped="true"
                  Height="300px"
                  FixedHeader="true">
            <HeaderContent>
                <MudTh>Zaman</MudTh>
                <MudTh>Mesaj</MudTh>
                <MudTh>Seviye</MudTh>
                <MudTh>Durum</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Zaman">@alert.Timestamp.ToLocalTime().ToString("HH:mm:ss")</MudTd>
                <MudTd DataLabel="Mesaj">
                    <MudText Typo="Typo.body2" Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">
                        @alert.Message
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Seviye">
                    @if (alert.Severity >= 3)
                    {
                        <MudChip T="string" Color="Color.Error" Size="Size.Small" Label="true">KRİTİK</MudChip>
                    }
                    else if (alert.Severity == 2)
                    {
                        <MudChip T="string" Color="Color.Warning" Size="Size.Small" Label="true">ORTA</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Label="true">DÜŞÜK</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Durum">@alert.Status</MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body2" Class="pa-4">Veri bekleniyor...</MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>

</MudContainer>

@code {
    private List<AlertDto> alerts = new List<AlertDto>();
    private int riskliSayisi = 0;
    private bool yukleniyor = true;

    // --- GRAFİK VERİLERİ (Simülasyon) ---
    // 1. Gün Beklentisi Grafiği
    public List<ChartSeries> SeriesExpectation = new List<ChartSeries>()
    {
        new ChartSeries() { Name = "Gerçekleşen", Data = new double[] { 40, 55, 25, 60, 80, 95, 40, 20 } },
        new ChartSeries() { Name = "Beklenen", Data = new double[] { 35, 50, 30, 55, 75, 90, 45, 25 } },
    };
    public string[] XAxisLabels = { "03:00", "06:00", "09:00", "12:00", "15:00", "18:00", "21:00", "00:00" };

    // 2. Önlenen Kayıp Grafiği
    public List<ChartSeries> SeriesLoss = new List<ChartSeries>()
    {
        new ChartSeries() { Name = "Önlenen Kayıp", Data = new double[] { 5, 12, 8, 25 } },
    };
    public string[] XAxisLabelsLoss = { "T1", "T2", "T3", "T4" }; // Türbinler

    protected override async Task OnInitializedAsync()
    {
        await VerileriYukle();
    }

    private async Task VerileriYukle()
    {
        yukleniyor = true;
        try
        {
            var veri = await ApiService.GetAlertsAsync();
            if (veri != null)
            {
                alerts = veri.OrderByDescending(x => x.Timestamp).Take(50).ToList();
                riskliSayisi = alerts.Count(a => a.Severity >= 3);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Hata: " + ex.Message, Severity.Error);
        }
        finally
        {
            yukleniyor = false;
        }
    }
}
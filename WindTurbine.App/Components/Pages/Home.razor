@page "/"
@using WindTurbine.App.Services
@using WindTurbine.DTOs.Alerts
@inject IApiService ApiService
@inject ISnackbar Snackbar

<PageTitle>Rüzgar SCADA Paneli</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6 mb-6">

    <div class="d-flex justify-content-between align-items-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Color="Color.Primary"><b>SCADA Kontrol Paneli</b></MudText>
            <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Canlı türbin verileri ve yapay zeka analizleri</MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="VerileriYukle"
                   Disabled="@yukleniyor">
            @(yukleniyor ? "Yükleniyor..." : "Verileri Yenile")
        </MudButton>
    </div>

    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="3" Class="pa-4 d-flex flex-column align-center justify-center" Style="background-color: #ffebee; border-left: 6px solid #f44336; height: 140px;">
                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Large" />
                <MudText Typo="Typo.h3" Color="Color.Error" Class="mt-1"><b>@riskliSayisi</b></MudText>
                <MudText Typo="Typo.body2">Riskli Uyarılar</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="3" Class="pa-4 d-flex flex-column align-center justify-center" Style="background-color: #e8f5e9; border-left: 6px solid #4caf50; height: 140px;">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                <MudText Typo="Typo.h4" Color="Color.Success" Class="mt-1"><b>AKTİF</b></MudText>
                <MudText Typo="Typo.body2">Sistem Durumu</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="3" Class="pa-4 d-flex flex-column align-center justify-center" Style="background-color: #e3f2fd; border-left: 6px solid #2196f3; height: 140px;">
                <MudIcon Icon="@Icons.Material.Filled.WindPower" Color="Color.Info" Size="Size.Large" />
                <MudText Typo="Typo.h4" Color="Color.Info" Class="mt-1"><b>98%</b></MudText>
                <MudText Typo="Typo.body2">Emreamadelik</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="3" Class="pa-4 d-flex flex-column align-center justify-center" Style="background-color: #fff3e0; border-left: 6px solid #ff9800; height: 140px;">
                <MudIcon Icon="@Icons.Material.Filled.Bolt" Color="Color.Warning" Size="Size.Large" />
                <MudText Typo="Typo.h4" Color="Color.Warning" Class="mt-1"><b>625 MW</b></MudText>
                <MudText Typo="Typo.body2">Günlük Üretim</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudText Typo="Typo.h5" Class="mb-3"><b>Canlı Alarm Akışı</b></MudText>

    <MudTable Items="@alerts" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@yukleniyor" LoadingProgressColor="Color.Info" Elevation="3">
        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Zaman</MudTh>
            <MudTh>Mesaj</MudTh>
            <MudTh>Seviye</MudTh>
            <MudTh>AI Güveni</MudTh>
            <MudTh>Durum</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="ID">@context.AlertId</MudTd>
            <MudTd DataLabel="Zaman">@context.Timestamp.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</MudTd>
            <MudTd DataLabel="Mesaj">@context.Message</MudTd>
            <MudTd DataLabel="Seviye">
                @if (context.Severity >= 3)
                {
                    <MudChip T="string" Color="Color.Error" Size="Size.Small">KRİTİK</MudChip>
                }
                else if (context.Severity == 2)
                {
                    <MudChip T="string" Color="Color.Warning" Size="Size.Small">ORTA</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Info" Size="Size.Small">DÜŞÜK</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="AI Güveni">
                <div class="d-flex align-center">
                    <MudProgressLinear Color="Color.Success" Value="@((double)(context.Confidence * 100))" Class="mr-2" Style="width: 80px;" />
                    <MudText Typo="Typo.caption">@((context.Confidence * 100).ToString("F0"))%</MudText>
                </div>
            </MudTd>
            <MudTd DataLabel="Durum">@context.Status</MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[]{5, 10, 20}" />
        </PagerContent>
    </MudTable>

</MudContainer>

@code {
    private List<AlertDto> alerts = new List<AlertDto>();
    private int riskliSayisi = 0;
    private bool yukleniyor = true;

    protected override async Task OnInitializedAsync()
    {
        await VerileriYukle();
    }

    private async Task VerileriYukle()
    {
        yukleniyor = true;
        try
        {
            // API'den verileri çek
            var veri = await ApiService.GetAlertsAsync();
            if (veri != null)
            {
                // Listeyi tarihe göre tersten sırala
                alerts = veri.OrderByDescending(x => x.Timestamp).ToList();
                riskliSayisi = alerts.Count(a => a.Severity >= 3);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Veri alınamadı: " + ex.Message, Severity.Error);
        }
        finally
        {
            yukleniyor = false;
        }
    }
}